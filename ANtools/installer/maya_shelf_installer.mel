// Mayaå·¥å…·æ¶äº‘ç«¯å®‰è£…å™¨ (MELç‰ˆæœ¬)
// åŠŸèƒ½ï¼šä»GitHubè‡ªåŠ¨ä¸‹è½½å¹¶å®‰è£…Mayaå·¥å…·æ¶
// ä½œè€…ï¼šAIä»£ç è€å¸ˆ
// ç‰ˆæœ¬ï¼š1.0

global proc mayaShelfInstaller()
{
    // è·å–Mayaç‰ˆæœ¬å’Œè·¯å¾„
    string $mayaVersion = `about -version`;
    string $userScriptDir = `internalVar -userScriptDir`;
    string $shelfDir = $userScriptDir + "shelf";
    string $iconDir = $userScriptDir + "icons";
    
    print("ğŸš€ å¼€å§‹å®‰è£…Mayaå·¥å…·æ¶...\n");
    print("Mayaç‰ˆæœ¬: " + $mayaVersion + "\n");
    print("è„šæœ¬ç›®å½•: " + $userScriptDir + "\n");
    
    // åˆ›å»ºå¿…è¦ç›®å½•
    if (!`filetest -d $shelfDir`) {
        sysFile -makeDir $shelfDir;
        print("âœ… åˆ›å»ºå·¥å…·æ¶ç›®å½•: " + $shelfDir + "\n");
    }
    
    if (!`filetest -d $iconDir`) {
        sysFile -makeDir $iconDir;
        print("âœ… åˆ›å»ºå›¾æ ‡ç›®å½•: " + $iconDir + "\n");
    }
    
    // æ˜¾ç¤ºå®‰è£…é€‰é¡¹å¯¹è¯æ¡†
    string $result = `confirmDialog 
        -title "Mayaå·¥å…·æ¶å®‰è£…å™¨"
        -message "è¯·é€‰æ‹©å®‰è£…æ–¹å¼:\n\n1. ä»GitHubä¸‹è½½å®‰è£…\n2. ä»æœ¬åœ°æ–‡ä»¶å®‰è£…\n3. ä»…åˆ›å»ºå·¥å…·æ¶ç»“æ„"
        -button "GitHubå®‰è£…" "æœ¬åœ°å®‰è£…" "åˆ›å»ºç»“æ„" "å–æ¶ˆ"
        -defaultButton "GitHubå®‰è£…"
        -cancelButton "å–æ¶ˆ"
        -dismissString "å–æ¶ˆ"`;
    
    if ($result == "GitHubå®‰è£…") {
        installFromGitHub();
    } else if ($result == "æœ¬åœ°å®‰è£…") {
        installFromLocal();
    } else if ($result == "åˆ›å»ºç»“æ„") {
        createShelfStructure();
    } else {
        print("âŒ å®‰è£…å·²å–æ¶ˆ\n");
        return;
    }
}

global proc installFromGitHub()
{
    print("ğŸ“¥ ä»GitHubå®‰è£…å·¥å…·æ¶...\n");
    
    // è·å–GitHubä»“åº“åœ°å€
    string $repoUrl = `promptDialog 
        -title "GitHubä»“åº“åœ°å€"
        -message "è¯·è¾“å…¥GitHubä»“åº“åœ°å€:"
        -button "ç¡®å®š" "å–æ¶ˆ"
        -defaultButton "ç¡®å®š"
        -cancelButton "å–æ¶ˆ"
        -text "ä½ çš„ç”¨æˆ·å/maya-shelf-tools"`;
    
    if ($repoUrl == "") {
        print("âŒ æœªè¾“å…¥ä»“åº“åœ°å€\n");
        return;
    }
    
    // è¿™é‡Œéœ€è¦Pythonè„šæœ¬æ¥å¤„ç†ä¸‹è½½
    // è°ƒç”¨Pythonå®‰è£…å™¨
    python("exec(open(r'maya_shelf_installer.py').read())");
}

global proc installFromLocal()
{
    print("ğŸ“ ä»æœ¬åœ°æ–‡ä»¶å®‰è£…å·¥å…·æ¶...\n");
    
    // é€‰æ‹©æœ¬åœ°æ–‡ä»¶å¤¹
    string $localPath = `fileDialog2 
        -fileMode 3 
        -caption "é€‰æ‹©å·¥å…·æ¶æ–‡ä»¶å¤¹"
        -okCaption "é€‰æ‹©"
        -cancelCaption "å–æ¶ˆ"`;
    
    if (size($localPath) == 0) {
        print("âŒ æœªé€‰æ‹©æ–‡ä»¶å¤¹\n");
        return;
    }
    
    string $sourceDir = $localPath[0];
    string $userScriptDir = `internalVar -userScriptDir`;
    string $iconDir = $userScriptDir + "icons";
    
    // å¤åˆ¶å·¥å…·æ–‡ä»¶
    string $toolsDir = $sourceDir + "/tools";
    if (`filetest -d $toolsDir`) {
        string $files[] = `getFileList -folder $toolsDir -filespec "*.py"`;
        string $files2[] = `getFileList -folder $toolsDir -filespec "*.mel"`;
        
        for ($file in $files) {
            string $sourceFile = $toolsDir + "/" + $file;
            string $destFile = $userScriptDir + $file;
            sysFile -copy $sourceFile $destFile;
            print("âœ… å®‰è£…å·¥å…·: " + $file + "\n");
        }
        
        for ($file in $files2) {
            string $sourceFile = $toolsDir + "/" + $file;
            string $destFile = $userScriptDir + $file;
            sysFile -copy $sourceFile $destFile;
            print("âœ… å®‰è£…å·¥å…·: " + $file + "\n");
        }
    }
    
    // å¤åˆ¶å›¾æ ‡æ–‡ä»¶
    string $iconsDir = $sourceDir + "/icons";
    if (`filetest -d $iconsDir`) {
        string $iconFiles[] = `getFileList -folder $iconsDir -filespec "*.png"`;
        string $iconFiles2[] = `getFileList -folder $iconsDir -filespec "*.jpg"`;
        
        for ($file in $iconFiles) {
            string $sourceFile = $iconsDir + "/" + $file;
            string $destFile = $iconDir + "/" + $file;
            sysFile -copy $sourceFile $destFile;
            print("âœ… å®‰è£…å›¾æ ‡: " + $file + "\n");
        }
        
        for ($file in $iconFiles2) {
            string $sourceFile = $iconsDir + "/" + $file;
            string $destFile = $iconDir + "/" + $file;
            sysFile -copy $sourceFile $destFile;
            print("âœ… å®‰è£…å›¾æ ‡: " + $file + "\n");
        }
    }
    
    // åˆ›å»ºå·¥å…·æ¶
    createCustomShelf();
    
    print("ğŸ‰ æœ¬åœ°å®‰è£…å®Œæˆï¼\n");
}

global proc createShelfStructure()
{
    print("ğŸ—ï¸ åˆ›å»ºå·¥å…·æ¶ç»“æ„...\n");
    
    // åˆ›å»ºé»˜è®¤å·¥å…·æ¶
    createCustomShelf();
    
    // åˆ›å»ºç¤ºä¾‹å·¥å…·æ–‡ä»¶
    createSampleTools();
    
    print("ğŸ‰ å·¥å…·æ¶ç»“æ„åˆ›å»ºå®Œæˆï¼\n");
}

global proc createCustomShelf()
{
    string $shelfName = "Custom Tools";
    
    // åˆ é™¤å·²å­˜åœ¨çš„å·¥å…·æ¶
    if (`shelfLayout -exists $shelfName`) {
        deleteUI $shelfName;
        print("ğŸ—‘ï¸ åˆ é™¤æ—§å·¥å…·æ¶: " + $shelfName + "\n");
    }
    
    // åˆ›å»ºæ–°å·¥å…·æ¶
    shelfLayout $shelfName;
    print("âœ… åˆ›å»ºå·¥å…·æ¶: " + $shelfName + "\n");
    
    // æ·»åŠ å·¥å…·æŒ‰é’®
    addToolButton($shelfName, "å…³èŠ‚æ§åˆ¶å™¨å¯¹é½", "joint_controller_aligned.mel", "joint_controller.png", "ä¸ºé€‰å®šéª¨éª¼åˆ›å»ºæ§åˆ¶å™¨å¹¶å¯¹é½åˆ°å…³èŠ‚è§’åº¦");
    addToolButton($shelfName, "æ¨¡å‹ç§»åŠ¨å™¨", "maya_model_mover.py", "model_mover.png", "æ‰¹é‡å¯¹é½æ¨¡å‹ä½ç½®");
    addToolButton($shelfName, "æ–‡å­—æ›²çº¿åˆå¹¶", "text_curves_merger.py", "curve_merger.png", "åˆå¹¶é€‰ä¸­çš„æ–‡å­—æ›²çº¿");
    addToolButton($shelfName, "å…³é”®å¸§åç§»", "kfSwordSwipe - cn - èƒ½å¤Ÿä¿®æ”¹é¢œè‰²+å¸ƒå±€ä¼˜åŒ–+ç¯å¢ƒå…‰è®¾ç½®.mel", "keyframe_offset.png", "å…³é”®å¸§åç§»å·¥å…·");
}

global proc addToolButton(string $shelfName, string $label, string $commandFile, string $iconFile, string $annotation)
{
    string $userScriptDir = `internalVar -userScriptDir`;
    string $iconDir = $userScriptDir + "icons";
    string $iconPath = $iconDir + "/" + $iconFile;
    
    // æ£€æŸ¥å›¾æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if (!`filetest -e $iconPath`) {
        $iconPath = "";
        print("âš ï¸ å›¾æ ‡æ–‡ä»¶ä¸å­˜åœ¨: " + $iconFile + "\n");
    }
    
    // æ„å»ºå‘½ä»¤
    string $command = "";
    if (`gmatch $commandFile "*.py"`) {
        $command = "python(\"exec(open(r'" + $userScriptDir + $commandFile + "').read())\");";
    } else if (`gmatch $commandFile "*.mel"`) {
        $command = "source \"" + $userScriptDir + $commandFile + "\";";
    }
    
    // æ·»åŠ æŒ‰é’®åˆ°å·¥å…·æ¶
    shelfButton 
        -parent $shelfName
        -label $label
        -command $command
        -image $iconPath
        -annotation $annotation
        -width 35
        -height 35;
    
    print("âœ… æ·»åŠ å·¥å…·: " + $label + "\n");
}

global proc createSampleTools()
{
    string $userScriptDir = `internalVar -userScriptDir`;
    
    // åˆ›å»ºç¤ºä¾‹MELè„šæœ¬
    string $melFile = $userScriptDir + "sample_tool.mel";
    string $melContent = "// ç¤ºä¾‹å·¥å…·è„šæœ¬\nprint(\"è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹å·¥å…·ï¼\");";
    
    int $fileId = `fopen $melFile "w"`;
    fprint $fileId $melContent;
    fclose $fileId;
    
    print("âœ… åˆ›å»ºç¤ºä¾‹å·¥å…·: sample_tool.mel\n");
}

// è¿è¡Œå®‰è£…å™¨
mayaShelfInstaller();
